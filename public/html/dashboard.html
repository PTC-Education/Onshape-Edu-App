<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Onshape 3D Printer Dashboard</title>

  <style id = 'interface' media="screen">
  body {
    padding: 0;
    margin: 0
  }
  #bannerDiv {
    position: fixed;
    width: 100%;
    height: 40px;
    z-index: 10;
    background-color: white;
    left: 0;
    bottom: 0;
    color: #656565;
    text-align: center;
    font-family: "Flama", "Open Sans","Helvetica Neue","Helvetica","Arial","sans-serif";
  }
  #updateButton {
    position: absolute;
    top: 30px;
    right: 30px;
    padding: 10px;
    background-color: rgba(255, 255, 255, 50%);
    color: #999;
    border-radius: 5px;
  }
  </style>

</head>

<body>
<h2>3D Printer Dashboard</h2>
<button id="updateButton" onclick="runCode(); return">Update Info</button>
<div id="printerImage">
    <h3>Loading...</h3>
</div>
<div id="printerInfo">
</div>
<form id="formElem">
    <label for="key">Key Name</label>
    <input type="text" name="key" value="John">
    <label for="key">Key Value</label>
    <input type="text" name="value" value="Smith">
    <input type="submit">
</form>
  
<script>
formElem.onsubmit = async (e) => {
    e.preventDefault();

    var inputData = new FormData(formElem);
    var key = inputData.get('key');
    var value = inputData.get('value')
    updateJSONTreeKey(localStorage.getItem('applicationId'),JSON.parse(localStorage.getItem('jsonTree'))['changeId'],key,value)
};
</script>

</body>

<script src="../appDashboard.js" charset="utf-8"></script>

<script>

// Update the workspace with the last saved workspace
getDashboardAppElementInfo()
  .then((value) => {var tree = getJSONTree(value.applicationId);
                    localStorage.setItem('applicationId',value.applicationId);
                    return tree})
  .then((value) => {localStorage.setItem('jsonTree',JSON.stringify(value));
                    return value})
  .then((value) => {updateInfo(value)})


function showImage(jsonTree) {
    // var jsonTree = JSON.parse(localStorage.getItem('jsonTree'));
    // console.log(jsonTree['tree']['image']);
    // console.log("<img src='"+localStorage.getItem('jsonTree')['tree']['image']+"'>")
    document.getElementById("printerImage").innerHTML = "<img src='"+jsonTree['tree']['image']+"' width=400>"
}

function updatePrinterInfo(jsonTree) {
    // var jsonTree = JSON.parse(localStorage.getItem('jsonTree'));
    var printerState = jsonTree['tree']['printerInfo']['state']['text']
    var nozzleTarget = jsonTree['tree']['printerInfo']['temperature']['tool0']['target']
    var nozzleActual = jsonTree['tree']['printerInfo']['temperature']['tool0']['actual']
    var bedTarget = jsonTree['tree']['printerInfo']['temperature']['bed']['target']
    var bedActual = jsonTree['tree']['printerInfo']['temperature']['bed']['actual']
    var jobState = jsonTree['tree']['jobInfo']['state']
    var jobFileName = jsonTree['tree']['jobInfo']['job']['file']['name']
    var jobProgress = jsonTree['tree']['jobInfo']['progress']['completion']
    var defaultText = `<ul>
      <li>Printer State: ${printerState.toString()}</li>
      <li>Temperature:
        <ul>
          <li> Nozzle Actual Temp: ${nozzleActual.toString()}</li>
          <li> Nozzle Target Temp: ${nozzleTarget.toString()}</li>
          <li> Bed Actual Temp: ${bedActual.toString()}</li>
          <li> Bed Target Temp: ${bedTarget.toString()}</li>
        </ul></li>
      <li>Job State: ${jobState}</li>
      <li>File Name: ${jobFileName}</li>
      <li>Completion Percentage: ${Math.round(jobProgress).toString()}</li>
    </ul>`
    document.getElementById("printerInfo").innerHTML = defaultText
}

async function updateInfo(tree) {
  updatePrinterInfo(tree);  
  showImage(tree);
}

async function runCode() {
  document.getElementById('updateButton').style.backgroundColor = "rgba(192, 192, 192, 0.5)"
  document.getElementById('updateButton').innerHTML = "Waiting for update..."
  document.getElementById('updateButton').style.color = "rgb(0, 0, 0)"
  updateJSONTreeKey(localStorage.getItem('applicationId'),JSON.parse(localStorage.getItem('jsonTree'))['changeId'],"updateInfo","update")
  checkInfoUpdate()
}

var checkInfoUpdate2 = function(){
  var tree = getJSONTree(value.applicationId)
  if (JSON.stringify(tree) == localStorage.getItem('jsonTree')) {
    updateInfo(tree)
    document.getElementById('updateButton').style.backgroundColor = "rgba(255, 255, 255, 0.5)"
    document.getElementById('updateButton').innerHTML = "Update Info"
    document.getElementById('updateButton').style.color = "rgb(153, 153, 153)"
    console.log("updated!")
    return true
  }
  else{
    return false
  }
  console.log("checked Info")
}

var OctoprintPollRate = 10000;

function checkInfoUpdate() {
  console.log('init update')
  setTimeout(function() {
    var tree = getJSONTree(localStorage.getItem('applicationId'))
    localStorage.setItem('jsonTree',JSON.stringify(tree))
    updateInfo(tree)
    console.log('updated')
  },OctoprintPollRate)
}

</script>
</html>
